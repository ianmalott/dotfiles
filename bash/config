#!/bin/bash

#
# Environment
#

export EDITOR=/usr/bin/vim
export PATH=/usr/local/bin:/usr/local/sbin:$PATH
export TERM=xterm-256color

#
# Functions
#

# Run tests matching pattern in file
# Usage: t <filename> <pattern>
function t {
  local filename="$1"
  shift
  ruby -Itest $filename -n "/$@/"
}

function vg {
  if [ $# -ge 2 ]; then
    local matching_files=$(grep -rl "$@")

    if [ "$matching_files" ]; then
      vim -p +/"$1" $matching_files
    else
      echo 'No matches found.'
    fi
  else
    echo 'Usage: vg <pattern> <path> [<path>...]'
  fi
}

# Project-specific screen sessions
for project in levelup payments scvngr; do
  eval "
    function $project () {
      cd ~/projects/$project # trigger rvm after_cd hook
      screen -dRRS $project -c ~/.dotfiles/screen/$project
    }
  "
done
unset project

#
# Git
#

source ~/.git-completion.bash
GIT_PS1_SHOWDIRTYSTATE=true # unstaged (*), staged (+)
GIT_PS1_SHOWSTASHSTATE=true # stashed ($)
GIT_PS1_SHOWUNTRACKEDFILES=true # untracked (%)

# Enable completion for 'g'
complete -o bashdefault -o default -o nospace -F _git g 2>/dev/null || complete -o default -o nospace -F _git g

#
# Prompt
#

PS1="\n$BLD_WHI\u$REG_RED@$REG_BLU\h $REG_CYA\w$BLD_GRE \$(__git_ps1 "%s")\n‚ùØ$DEFAULT "

#
# RVM (must be last)
#
[[ -s "$HOME/.rvm/scripts/rvm" ]] && source "$HOME/.rvm/scripts/rvm"
